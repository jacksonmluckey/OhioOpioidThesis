
```{r setup}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(citr)
```

```{r load_packages_and_df}
# Load the libraries and data used in this Rmd file
library(tidyverse)
library(here)
library(knitr) # for kable
library(tidycensus)
load(here("data", "df.Rda"))
```

```{r variable_ordering}
################################
# Disability Variable Ordering #
################################
base_disability_list <- c("disability_percent_under5", "disability_percent_5to17", "disability_percent_18to34", "disability_percent_35to64", "disability_percent_65to74", "disability_percent_75andup")

# adds a suffix to a string
# used for generating the male and female disability lists
add_suffix <- function(string, suffix) {
  string <- paste0(string, suffix)
  string
}

# create male, female, and unified disability variable ordering list
# and then turn them back into usable vectors
# instead of lists (to avoid the [[]] nonsense and ambiguity with tidyselect)
male_disability_ordering <- base_disability_list %>%
  map(add_suffix, "_male") %>%
  as.character()
female_disability_ordering <- base_disability_list %>%
  map(add_suffix, "_female") %>%
  as.character()
disability_ordering <- c(male_disability_ordering, female_disability_ordering)

###############################
# Education Variable Ordering #
###############################
education_ordering <- c("education_b_percent_highschool_or_less", "education_b_percent_college_or_more",
                        "education_s_percent_less_than_highschool", "education_s_percent_highschool",
                        "education_s_percent_ged", "education_s_percent_some_college", "education_s_percent_college",
                        "education_s_percent_graduate")

############################
# Master Variable Ordering #
############################
misc_variable_ordering <- c("OD_rate", "income_pc_individual", "percent_white", "percent_black", "population", "deaths")
master_variable_ordering <- c(misc_variable_ordering, education_ordering, disability_ordering)
```

```{r grab_county_geometry}
base_map <- get_acs("county",
                    state = "OH",
                    table = "B02001",
                    geometry = TRUE,
                    output = "wide")
# reduce down to GEOID and geometry
base_map <- base_map %>%
  select(GEOID, geometry)
```

```{r map_theme}
theme_map <- theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major = element_blank())
```

# Data

Census data is stored by table, year, geography, and survey...

The majority of my independent variables were sourced from the census Annual Community Survey. The Annual Community Survey, or ACS, "provides a detailed portrait of the social, economic, housing, and demographic characteristics of Americaâ€™s communities" [@UnderstandingACSBasics2020]. ACS data is available on a geographic hierarchy, going from census tracts to the United States as a whole. This thesis uses ACS data aggregated at the county level from the one-year survey [@GeographicAreasCovered2020]. Due to changes in the way that ACS data was collected in 2010, the dataset includes ACS data from the years 2012 to 2018. Tables are not necessarily consistent between years [@UnderstandingACSBasics2020].

## Sample Size

Unfortunately, not all counties in Ohio are included in the Annual Community Survey. Only counties with a population of 65,000 or greater are included in the one year Annual Community Survey [@GeographicAreasCovered2020]. In total, the sample includes 39 out of Ohio's 88 counties. Since the census data is censored based on county population, there is selection bias in the sample. This means that my results may be an inaccurate reflection of reality if there is correlation between a county's population and the county's fatal drug overdose rate. Given that the literature suggests that rural areas have suffered from greater increases in overdose rates, it is likely that there is correlation between county population and the overdose rate, meaning that there is likely selection bias in the dataset.

Counties excluded in the one year Annual Community Survey are available in other U.S. Census Bureau datasets. Counties with at least a population of 20,000 are included in the one year Annual Community Survey supplemental estimates, which provide a more limited version of the tables included in the broader one year Annual Community Survey. Furthermore, the ACS five year estimates include many counties excluded from the one-year estimates, and the decennial survey includes all areas [@UnderstandingACSBasics2020].

```{r included_counties_map}
df %>%
  group_by(county, GEOID) %>%
  summarize(population = mean(population)) %>%
  full_join(base_map, by = c("GEOID" = "GEOID")) %>%
  mutate(included = !is.na(population)) %>%
  ggplot(aes(geometry = geometry, fill = included)) +
  geom_sf() +
  labs(fill = "Included in Sample?",
       title = "Counties included in sample",
       x = "",
       y = "") +
  theme_map +
  scale_fill_viridis_d()
```

```{r check_if_excluded_counties_have_higher_od_rate}
# do something here
```

## Variable Summary Statistics

For the education variables, "_b_" refers to big bins (e.g. college or more, high school or less), while "_s_" refers to small bins (e.g. some college, college, graduate school). The big bins are calculated by aggregating the smaller bins, and exclude individuals with some amount of college education.

Race is included as the variable "percent_black". Racial demographic data is represented this way because census demographic data that distinguishes between cacausian and latinx is significantly more challenging to work with, as the categories provided do not neatly add up the total population of the county. Since heroin was considered an urban black drug from the late 1930s until recently, "percent_black" seemed an effective enough variable for assesing the role of race in drug overdose rates [@macyDopesickDealersDoctors2018; @quinonesDreamlandTrueTale2016; @whiteSlayingDragonHistory1998].

Disability is 

```{r summary_stats_all_variables, results="asis"}
df %>%
  select(-GEOID, -county, -year) %>%
  select(all_of(master_variable_ordering)) %>%
  summarize_all(list(min, max, mean, sd), na.rm = TRUE) %>%
  pivot_longer(everything()) %>% # turns into a 2 column df
  mutate(func = str_match(name, "_fn([1-4])")[,2]) %>% # func identifies which transformation was used
  mutate(func = case_when(func == 1 ~ "Min", # converts func into a meaninful label
                          func == 2 ~ "Max",
                          func == 3 ~ "Mean",
                          func == 4 ~ "Standard Deviation")) %>%
  mutate(name = str_remove(name, "_fn[1-4]")) %>% # strips the suffix which was turned into func
  pivot_wider(names_from = func, values_from = "value") %>% # untidies but makes easy to use
  mutate(`Variable Name` = name, # make the variable name label better
         name = NULL) %>%
  select(`Variable Name`, everything()) %>% # gets the variable name in front
  kable(caption = "Summary statistics of all variables used in analysis",
        format.args = list(scientific = FALSE,
                           big.mark = ","))
```

```{r OD_rate_distribution}
df %>%
  filter(!is.na(OD_rate)) %>% # drop the NA rows that occur because of the missing 2018 deaths data
  ggplot(aes(x = OD_rate)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  ggtitle("Distribution of Overdose Rate") +
  labs(y = "", x = "Overdose Rate (Deaths per 10,000)") +
  theme(axis.text.y = element_blank(),
        plot.title = element_text(hjust = 0.5))
```

Consider tobit model due to censoring.

```{r county_racial_distribution}
df %>%
  ggplot(aes(x = percent_black)) +
  geom_histogram(bins = 20) +
  theme_minimal() +
  ggtitle("Distribution of Percent Black") +
  labs(x = "Percent Black", y = "") +
  scale_x_continuous(labels = function(x) paste0(x, "%")) + # adds percentage signs; scales::percent assumes .XXX format, while I have XX.X
  theme(axis.text.y = element_blank(),
        plot.title = element_text(hjust = 0.5))
```

## Maps

Let's draw some maps.

```{r percent_black_maps}
df %>%
  group_by(county, GEOID) %>%
  summarize(percent_black = mean(percent_black)) %>%
  full_join(base_map, by = c("GEOID" = "GEOID")) %>%
  ggplot(aes(fill = percent_black, geometry = geometry)) +
  geom_sf() +
  theme_map +
  scale_fill_viridis_c() +
  labs(subtitle = "Grey means excluded from sample",
       title = "Percent Black by County",
       fill = "% Black")
```

The yellow county is Cuyahoga County, which contains the city of Cleveland. Before the 1990s, Cleveland was considered to be the only part of Ohio to contain a significant heroin market [@quinonesDreamlandTrueTale2016]. Therefore, we would expect Cleveland to have started off with an above average drug overdose death rate. With the rise of the Xalisco boys and the introduction of OxyContin, heroin markets spread across the state [@macyDopesickDealersDoctors2018; @quinonesDreamlandTrueTale2016]. Hence, we would expect Cleveland, and therefore Cuyahoga County, to have a higher than average overdose rate prior to the mid 90s, and for other counties to have a larger increase in their overdose death rate.

# Methods

I used the R package Tidycensus to download census data. Tidycensus was created by Kyle Walker and is maintained by a community on GitHub. Tidycensus allows "R users to return Census and ACS data as tidyverse-ready data frames, and optionally returns a list-column with feature geometry for many geographies". The "list-column with feature geometry" allows the R user to easily draw maps using the downloaded census data and a ggplot2 one-liner. Dataframes can be downloaded in either a wide or tidy format, and brief descriptions of each variable are available. The package is an API wrapper for data.census.gov, and the API calls it creates can be accessed and manually ran using packages such as rvest [@walkerTidycensus].

In order to better use Tidycensus, I wrote custom functions to accomplish several repeated tasks. One set of functions allows the user to download multiple years of a particular census table at once. The functions accept a table code and year range, and download the table for each year, pivot it into a wide format, add a year column, and bind the rows of the resulting dataframes into one master dataframe, which is returned. Another function modifies the "county" column, removing the string "County, Ohio" from each entry in order to make it easier to join with other datasets.

Census tables were identified through several means. Using Tidycensus's "load_variables" function, I created a dataframe of all variables covered in the package and filtered it using keywords and R's grep wrapper. Keywords were selected by brainstorming off of the hypothesis that the literature put forward. For example, I used the keyword "disability" for the disability variables, "median income" and "average income" and "mean income" for income, and so on. Furthermore, Reed's data services librarian, Mahria Lebow, helped me identify relevant census tables by examining the census table shells and going through the documentation available at data.census.gov [@lebowCensusHelp]. I decided to start off with one year Annual Community Survey data because it had a relatively limited number of variables, making it easier to work with, and it provided more statistical power than relying on the decennial survey, which at best offered three rows per county (1990, 2000, 2010).

Plots, graphs, and maps that appear within this thesis were produced using ggplot2 unless otherwise noted. ggplot2 is a R package that is part of the Tidyverse universe of R packages. The package allows for a R user to quickly produce aesthetically appealing graphs and maps using any tidy dataset. Visualizations made in ggplot2 are designed using a standardized "grammar of graphics", which helps keep the visual appearance of a variety of different types of visualizations consistent [@wickhamGgplot2ElegantGraphics2016]. One major advantage of working with Tidyverse-compliant packages such as ggplot2 and Tidycensus is that they are designed to work together easily. This allows a R user to go directly from pulling down census data to making maps without having to reshape data or otherwise perform tedious data cleaning, wrangling, and preparation tasks [@walkerTidycensus2020; @wickhamGgplot2ElegantGraphics2016].

Initial regressions were performed using simple linear regression.

In addition to the simple linear regression models, a model with a censored dependent variable is also used. This model, referred to as a Tobit model, is used when there is censoring of the dependent variable. Censoring is when all values above or below a particular value are recorded as one value. For example, income data where all incomes over $100,000 a year are coded as $100,000 is censored from above.

