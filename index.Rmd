---
author: 'Jackson Maillie Luckey'
date: 'May 2020'
institution: 'Reed College'
division: 'History and Social Sciences'
advisor: 'Denise Hare'
department: 'Economics'
degree: 'Bachelor of Arts'
title: 'Social and Economic Determinants of the Opioid Overdose Death Rate in Ohio'
knit: "bookdown::render_book"
site: bookdown::bookdown_site
output: 
  thesisdown::thesis_pdf: default
abstract: |
  `r if(knitr:::is_latex_output()) paste(readLines("00-abstract.Rmd"), collapse = '\n  ')`
acknowledgements: |
  First of all, I would like to thank my thesis advisor, Denise Hare, for supporting me throughout the thesis process. I would also like to thank Nick Wilson for being my first reader, giving me invaluable feedback throughout the thesis project, and for teaching me health economics.

  Reed staff have been just as important as faculty in supporting my thesis. In particular, I would like to thank Kristin Bott and Mahria Lebow. I learned the R skills that provided the backbone of this thesis primarily through working for Kristin in Reed's mLab. Furthermore, she has connected me with resources at Reed as I ran into issues working through my thesis. Reed's data services librarian, Mahria Lebow, helped me navigate census data and saved me countless hours of futile struggling with the census API. Without their help, I would likely still be trying to gather my data.

  I would like to thank my father, Bill Luckey, for introducing me to public health policy and the study of addiction. Without his influence in my life, I would not have gone down this path. I'd also like to thank my mom for helping me get through my years at Reed.

  I would also like to thank Arnie Aldridge, Brendan Wedehase, and Gary Zarkin for their invaluable role in my thesis. Without their guidance during my internship at RTI, I would have never developed the technical skills nor background knowledge that was necessary for producing this document.
  
  Finally, I would like to thank everyone at FEI for helping me introduce me to substance use disorder policy and treatment research.
# Specify the location of the bibliography below
bibliography: bib/thesis.bib
# Download your specific csl file and refer to it in the line below.
csl: csl/chicago-fullnote-bibliography.csl
lot: true
lof: true # the figure captions are fucky
header-includes:
  \usepackage{tikz}
---

```{r includePackages, include = FALSE}
# This chunk ensures that the thesisdown package is
# installed and loaded. This thesisdown package includes
# the template files for the thesis.
if(!require(devtools))
  install.packages("devtools", repos = "http://cran.rstudio.com")
if(!require(thesisdown))
  devtools::install_github("ismayc/thesisdown")
library(thesisdown)
```

```{r loadPackages, include=FALSE, eval=TRUE}
# Load the libraries and data used in this Rmd file
library(tidyverse)
library(tidycensus)
library(broom) # for manipulating regression output
library(here)
library(knitr) # for kable
library(kableExtra)
library(citr)
library(censReg)
library(stargazer) # for regression output
load(here("data", "df.Rda"))
#options(knitr.table.format = "latex",
#        knitr.table.format.args = list(scientific = FALSE,
#                           big.mark = ",",
#                           digits = 5),
options(knitr.table.format.args = list(scientific = FALSE,
        big.mark = ",",
        digits = 5),
        knitr.table.booktabs = T)
opts_chunk$set(include = TRUE,
               echo = FALSE,
               message = FALSE,
               warning = FALSE) # have R code only appear in appendix
```

# Introduction {.unnumbered}

The current opioid epidemic is the worst drug epidemic in US history. While opioids are a legitimate medical treatment for acute pain, they are highly addictive and come with the risk of abuse, dependence, and fatal overdose [@aliprantisOpioidsLaborMarket2018]. Abuse of and dependence on opioids has serious consequences. Since 2016, drug overdoses have been the leading cause of accidental death in the United States [@maguireOpioidCrisisAppalachia2019]. Overdoses kill more people than gun violence, motor vehicle incidents, or the HIV/AIDS epidemic did at its peak [@quinonesDreamlandTrueTale2016; @ciccaroneFentanylUSHeroin2017; @alpertSupplySideDrugPolicy2017]. In fact, the scourge of opioid overdoses is so severe that it has lead to an increase in all-cause mortality for white Americans despite mortality decreasing for all other Americans and citizens of comparably developed countries [@caseMortalityMorbidity21st2017]. Reducing the number of deaths due to opioids is essential to reversing this trend, increasing the labor supply, and improving outcomes for millions of Americans.

In this thesis, I will start by reviewing the literature. The literature review will open by defining rationality in the context of economics. I will follow this up by examining the different models of addiction and how they approach rationality, and what these models say about opioid addiction policy. I will then examine the history of the opioid epidemic. I will open this by defining opioids, then provide a brief timeline, and then discuss the first American opioid epidemic (which occurs shortly after the Chinese opioid epidemic). Next, I will discuss the factors that led to the current opioid epidemic, such as changes in physician attitudes towards opioids and the introduction of Oxycontin. I will then describe the transition from prescription painkillers to heroin and synthetic opioids, and how they became available across the United States. I will briefly discuss opioid addiction treatment and naloxone, and then give a quick rundown on the state of Ohio. I end the literature review by classifying explanations as either supply side or demand side. In my data and methods chapter, I provide summary statistics of my data, describe how I acquired it from the U.S. Census and the CDC, and then explain my choice of statistical methods in chapter 3. In my results chapter, I run Tobit and ordinary least squares regressions, and then briefly describe the results. Finally, I provide a conclusion and a copy of some of the code I used to produce this thesis.

```{r censusFunctions}
make_census_table_wide <- function(df) {
  
  df <- df %>%
    select(-label, -concept) %>%
    pivot_longer(cols = c(estimate, moe)) %>%
    pivot_wider(names_from = c(name, variable), values_from = value)
  
}

# removes " County, Ohio" from county column (because it's the same in all cases)
clean_county_col<- function(df) {
  
  df <- df %>%
    mutate(county = str_remove(county, " County, Ohio"))
  
}

clean_tidycensus_table <- function(df) {
  
  # rename the "NAME" column to county
  df <- df %>%
    rename(county = NAME)
  
  df <- clean_county_col(df)
  
}

get_census_table <- function(table, year) {
  df <- get_acs("county",
                year = year,
                table = table,
                survey = "acs1", # if things break for older code make a version of this function with this line removed
                state = "OH")
  df <- clean_tidycensus_table(df)
}

# wrapper for get_census_table that handles a year range
get_census_table_multiple_years <- function(table, years) {
  count <- 0
  for (year in years) {
    tmp <- get_census_table(table, year)
    tmp$year <- year
    if (count == 0) {
      df <- tmp
      count <- 1
    } else {
      df <- bind_rows(tmp, df)
    }
  }
  df
}

var_labels <- function(table) {
  load_variables(2010, "acs1", cache = TRUE) %>%
    filter(str_detect(name, paste0(table, "_"))) %>%
    rename(variable = name)
}
```

```{r censusData}
# Pulls down data from census if it is not already stored as a .Rda object in data/
if(!file.exists(here("data", "df.Rda"))){
  
  ####################
  # grab census data #
  ####################
  
  disability <- get_census_table_multiple_years("B18101", 2012:2018) %>%
    left_join(var_labels("B18101")) %>%
    make_census_table_wide %>%
    mutate(disability_percent_under5_male = estimate_B18101_004 / estimate_B18101_003,
           disability_percent_5to17_male = estimate_B18101_007 / estimate_B18101_006,
           disability_percent_18to34_male = estimate_B18101_010 / estimate_B18101_009,
           disability_percent_35to64_male = estimate_B18101_013 / estimate_B18101_012,
           disability_percent_65to74_male = estimate_B18101_016 / estimate_B18101_015,
           disability_percent_75andup_male = estimate_B18101_019 / estimate_B18101_018,
           disability_percent_under5_female = estimate_B18101_023 / estimate_B18101_022,
           disability_percent_5to17_female = estimate_B18101_026 / estimate_B18101_025,
           disability_percent_18to34_female = estimate_B18101_029 / estimate_B18101_028,
           disability_percent_35to64_female = estimate_B18101_032 / estimate_B18101_031,
           disability_percent_65to74_female = estimate_B18101_035 / estimate_B18101_034,
           disability_percent_75andup_female = estimate_B18101_038 / estimate_B18101_037) %>%
    select(GEOID, county, year, starts_with("disability"))
  
  race <- get_census_table_multiple_years("B02001", 2010:2018) %>%
    left_join(var_labels("B02001")) %>%
    make_census_table_wide() %>%
    mutate(percent_white = estimate_B02001_002 / estimate_B02001_001,
           percent_black = estimate_B02001_003 / estimate_B02001_001) %>%
    select(GEOID, county, year, percent_white, percent_black)
  
  income <- get_census_table_multiple_years("B06011", 2010:2018) %>%
    left_join(var_labels("B06011")) %>%
    make_census_table_wide() %>%
    rename(income_pc_individual = estimate_B06011_001) %>%
    select(GEOID, county, year, income_pc_individual)
  
  # education
  education <- get_census_table_multiple_years("C15003", 2010:2018) %>%
    left_join(var_labels("C15003")) %>%
    make_census_table_wide() %>%
    rename(population = estimate_C15003_001) %>%
    # create the small education bins (_s_), which should add up to one
    mutate(education_s_percent_less_than_highschool = (estimate_C15003_002 + estimate_C15003_003 + estimate_C15003_004 + estimate_C15003_005 + estimate_C15003_006 + estimate_C15003_007 + estimate_C15003_008 + estimate_C15003_009) / population,
           education_s_percent_highschool = estimate_C15003_010 / population,
           education_s_percent_ged = estimate_C15003_011 / population,
           education_s_percent_some_college = (estimate_C15003_012 + estimate_C15003_013 + estimate_C15003_014) / population,
           education_s_percent_college = estimate_C15003_015 / population,
           education_s_percent_graduate = (estimate_C15003_016 + estimate_C15003_017 + estimate_C15003_018) / population) %>%
    # create the big education bins (_b_), which won't add up to one because some college is excluded
    mutate(education_b_percent_highschool_or_less = education_s_percent_less_than_highschool + education_s_percent_highschool + education_s_percent_ged,
           education_b_percent_college_or_more = education_s_percent_college + education_s_percent_graduate) %>%
    select(GEOID, county, year, population, starts_with("education"))
  
  df <- left_join(income, race) %>%
    left_join(disability) %>%
    left_join(education)
  
  #############
  # finish up #
  #############
  # death data
  # 2018 values will always be 0
  # might be able to get better data directly from CDC?
  # GET DEATHS INTO RATE
  # BRING IN DESCRIPTIVE/SUMMARY statistics
  deaths <- read_csv("Data/OverdoseDeathsTall.csv") %>%
    rename(county = County)
  
  # prepare final df
  df <- left_join(disability, race) %>%
    left_join(deaths) %>%
    left_join(education) %>%
    left_join(income_individual)
  
  # convert OD raw to OD rate
  # change OD rate to be deaths per 10,000 pop
  df <- df %>%
    mutate(OD_rate = (deaths / population) * 10000)
  
  # convert percentages to be XX.X instead of .XXX
  df <- df %>%
    mutate_at(vars(contains("percent")), ~ .x * 100)
  
  # add CDC overdose death rate
  # downloaded from https://www.cdc.gov/nchs/data-visualization/drug-poisoning-mortality/#data-tables
  OverdoseDeathRateCDC <- read_csv(here("data", "OverdoseDeathRate.csv")) %>%
    filter(State == "Ohio") %>%
    select(GEOID = FIPS,
           county = County,
           year = Year,
           DeathRateCDC = `Model-based Death Rate`,
           PopulationCDC = Population,
           UrbanRural = `Urban/Rural Category`) %>%
    mutate(county = str_remove(county, " County, OH")) %>%
    mutate(GEOID = as.character(GEOID)) # to enable merging with DF
  
  
  df <- left_join(df, OverdoseDeathRateCDC, by = c("GEOID" = "GEOID",
                                                   "year" = "year",
                                                   "county" = "county"))
  # save the final df as RDA file
  save(df, file  = here("data", "df.Rda"))
  
} else {
  load(here("data", "df.Rda"))
}
```

```{r prescribingRate}
# download prescription data for one particular year
prescriptionYear <- function(year) {
  year <- as.character(year)
  df <- glue("https://www.cdc.gov/drugoverdose/maps/rxcounty{year}.html") %>%
    read_html() %>%
    html_node("table") %>%
    html_table() %>%
    mutate(year = year)
  colnames(df) <- c("county", "State", "FIPS", "PrescribingRate", "year")
  df <- df %>%
    filter(State == "OH") %>%
    select(-State, -FIPS) %>%
    mutate(county = str_remove(county, ", OH"))
}

# years covered in CDC data
years <- 2006:2018

if(!file.exists(here("data", "prescriptions.Rda"))) {
  prescriptions <- map_dfr(years, prescriptionYear) %>%
    mutate(county = as_factor(county),
           PrescribingRate = as.numeric(PrescribingRate))
  save(prescriptions, file = here("data", "prescriptions.Rda"))
} else {
  load(here("data", "prescriptions.Rda"))
}
```

```{r grabCountyGeometry, echo=FALSE, message=FALSE, warning=FALSE}
base_map <- get_acs("county",
                    state = "OH",
                    table = "B02001",
                    geometry = TRUE,
                    output = "wide")
# reduce down to GEOID and geometry
base_map <- base_map %>%
  select(GEOID, geometry, county = NAME)
```

```{r mapTheme}
theme_map <- theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major = element_blank())
```

```{r recodeVariables}
# Variable Name is the name in df
# Category is for grouping the rows of the table
# Label is for replacing Variable Name (it's a human-readable version)
var_label_category <- tribble(
  ~`Variable Name`, ~Category, ~Label,
"OD_rate", "Overdoses", "Fatal Overdoses per 10,000",
"income_pc_individual", "Demographics", "Individual Per Capita Income",
"percent_white", "Race", "Percent White",
"percent_black", "Race", "Percent Black",
"population", "Demographics", "Population",
"deaths", "Overdoses", "Overdose Deaths",
"education_b_percent_highschool_or_less", "Broad Education", "Highschool or Less",
"education_b_percent_college_or_more", "Broad Education", "Bachelor's Degree or More",
"education_s_percent_less_than_highschool", "Education", "Less than Highschool",
"education_s_percent_highschool", "Education", "Highschool",
"education_s_percent_ged", "Education", "GED",
"education_s_percent_some_college", "Education", "Some College",
"education_s_percent_college", "Education", "College",
"education_s_percent_graduate", "Education", "Graduate School",
"disability_percent_under5_male", "Disability Male", "Percent 5 or Younger",
"disability_percent_5to17_male", "Disability Male", "Percent 5 to 17",
"disability_percent_18to34_male", "Disability Male", "Percent 18 to 34",
"disability_percent_35to64_male", "Disability Male", "Percent 35 to 64",
"disability_percent_65to74_male", "Disability Male", "Percent 65 to 74",
"disability_percent_75andup_male", "Disability Male", "Percent 75 and Up",
"disability_percent_under5_female", "Disability Female", "Percent 5 or Younger",
"disability_percent_5to17_female", "Disability Female", "Percent 5 to 17",
"disability_percent_18to34_female", "Disability Female", "Percent 18 to 34",
"disability_percent_35to64_female", "Disability Female", "Percent 35 to 64",
"disability_percent_65to74_female", "Disability Female", "Percent 65 to 74",
"disability_percent_75andup_female", "Disability Female", "Percent 75 and Up",
)
recode_vars <- function(df) {
  # relies on var_label_caetgory existing in the global env
  # which is bad practice but will do for the 1st draft
  df %>%
    left_join(var_label_category, by = c("Variable Name" = "Variable Name")) %>%
    mutate(rawVarName = `Variable Name`,
           `Variable Name` = Label)
}
```